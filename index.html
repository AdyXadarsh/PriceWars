<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Care Point Billing Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-card { border-left: 4px solid transparent; transition: 0.2s; }
        .test-card:active { scale: 0.98; }
        .cat-pathology { border-left-color: #ef4444; }
        .cat-xray { border-left-color: #3b82f6; }
        .cat-ultrasound { border-left-color: #10b981; }
        .cat-specialstudies { border-left-color: #f59e0b; }
        .cat-ecg { border-left-color: #8b5cf6; }
        .cat-package { border-left-color: #f59e0b; border-left-width: 6px; }
        
        .sticky-summary { position: sticky; bottom: 0; background: white; border-top: 2px solid #e2e8f0; z-index: 100; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        @keyframes bounce-in {
            0% { transform: translate(-50%, -100%); opacity: 0; }
            70% { transform: translate(-50%, 10px); opacity: 1; }
            100% { transform: translate(-50%, 0); opacity: 1; }
        }
        .animate-upsell { animation: bounce-in 0.5s ease-out forwards; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen pb-40">

    <header class="bg-slate-900 text-white p-4 shadow-md sticky top-0 z-50">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-lg font-black tracking-tighter uppercase">Care Point Diagnostics</h1>
                <p class="text-[10px] text-blue-400 font-bold uppercase tracking-widest">By Ady</p>
            </div>
            <button onclick="clearAll()" class="text-xs bg-slate-800 px-3 py-1 rounded-full text-slate-400 hover:text-white">Reset</button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4">
        <div class="mb-6 relative">
            <input type="text" id="mainSearch" placeholder="Search tests or packages..." 
                class="w-full p-4 pl-12 rounded-2xl border-none shadow-lg focus:ring-4 focus:ring-blue-500/20 text-lg">
            <i class="fas fa-search absolute left-4 top-5 text-slate-300"></i>
        </div>

        <div class="flex gap-2 overflow-x-auto pb-4 mb-2 no-scrollbar">
            <button class="filter-btn bg-blue-600 text-white px-5 py-2 rounded-xl font-bold transition" data-filter="all">All</button>
            <button class="filter-btn bg-white text-slate-600 px-5 py-2 rounded-xl border font-bold transition" data-filter="pkg">ðŸ”¥ Packages</button>
            <button class="filter-btn bg-white text-slate-600 px-5 py-2 rounded-xl border font-bold transition" data-filter="Pathology">Pathology</button>
            <button class="filter-btn bg-white text-slate-600 px-5 py-2 rounded-xl border font-bold transition" data-filter="Ultrasound">Ultrasound</button>
            <button class="filter-btn bg-white text-slate-600 px-5 py-2 rounded-xl border font-bold transition" data-filter="X-Ray">X-Ray</button>
        </div>

        <div id="grid" class="grid grid-cols-1 md:grid-cols-2 gap-3"></div>
    </main>

    <div class="sticky-summary p-4 shadow-[0_-10px_30px_rgba(0,0,0,0.1)]">
        <div class="max-w-4xl mx-auto">
            <div id="cart" class="flex flex-wrap gap-2 mb-4 max-h-24 overflow-y-auto">
                <p class="text-slate-400 text-sm italic">No tests selected yet...</p>
            </div>
            
            <div class="flex justify-between items-end">
                <div>
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest block">Total Amount</span>
                    <span class="text-4xl font-black text-slate-900">â‚¹<span id="total">0</span></span>
                </div>
                <div class="flex gap-2">
                    <button onclick="copyToClipboard()" id="copyBtn" class="bg-blue-100 text-blue-700 px-6 py-4 rounded-2xl font-bold flex items-center gap-2">
                        <i class="fas fa-copy"></i> COPY
                    </button>
                    <button onclick="generateMessage()" class="bg-green-600 text-white px-8 py-4 rounded-2xl font-black shadow-xl flex items-center gap-3">
                        <i class="fab fa-whatsapp"></i> SEND
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let data = [];
        let selected = [];
        let dismissedAlerts = new Set();

        async function init() {
            try {
                const res = await fetch('tests.json');
                data = await res.json();
                render('all');
            } catch (e) {
                document.getElementById('grid').innerHTML = "<p class='p-4 text-red-500'>Error: tests.json not found.</p>";
            }
        }

        function render(filterType, search = '') {
            const grid = document.getElementById('grid');
            grid.innerHTML = '';
            
            const filtered = data.filter(t => {
                const matchesSearch = t.n.toLowerCase().includes(search.toLowerCase());
                
                if (filterType === 'all') return matchesSearch;
                if (filterType === 'pkg') return t.is_pkg && matchesSearch;
                return t.c === filterType && matchesSearch;
            });

            filtered.forEach(test => {
                const div = document.createElement('div');
                const cleanCat = test.is_pkg ? 'package' : test.c.toLowerCase().replace(/\s/g, '');
                div.className = `test-card bg-white p-4 rounded-2xl shadow-sm cursor-pointer flex justify-between items-center cat-${cleanCat}`;
                div.onclick = () => { selected.push(test); updateCart(); };
                
                div.innerHTML = `
                    <div class="flex-1 pr-2">
                        <span class="text-[9px] font-black text-slate-400 uppercase">${test.is_pkg ? 'Health Bundle' : test.c}</span>
                        <h3 class="font-bold text-slate-800 leading-tight">${test.n}</h3>
                        <p class="text-[10px] text-slate-400 mt-1 line-clamp-2">${test.r}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-black text-lg">â‚¹${test.p}</p>
                        <span class="text-[10px] text-blue-600 font-bold uppercase">+ Add</span>
                    </div>`;
                grid.appendChild(div);
            });
        }

        function remove(idx) {
            selected.splice(idx, 1);
            updateCart();
        }

        function clearAll() {
            if(confirm("Clear selection?")) {
                selected = [];
                dismissedAlerts.clear();
                updateCart();
            }
        }

        function updateCart() {
            const cartDiv = document.getElementById('cart');
            const totalSpan = document.getElementById('total');
            
            if(selected.length === 0) {
                cartDiv.innerHTML = '<p class="text-slate-400 text-sm italic">No tests selected yet...</p>';
                totalSpan.innerText = '0';
                return;
            }

            cartDiv.innerHTML = selected.map((t, i) => `
                <div class="bg-slate-900 text-white px-3 py-1.5 rounded-full text-xs font-bold flex items-center gap-2">
                    ${t.n}
                    <i class="fas fa-times-circle text-slate-500 cursor-pointer" onclick="remove(${i})"></i>
                </div>`).join('');

            const sum = selected.reduce((acc, t) => acc + t.p, 0);
            totalSpan.innerText = sum.toLocaleString('en-IN');

            // Upsell Logic
            const packages = data.filter(t => t.is_pkg);
            packages.forEach(pkg => {
                const inCart = selected.filter(t => t.p_id === pkg.pkg_id);
                const totalInPkg = data.filter(t => t.p_id === pkg.pkg_id).length;
                const hasPkg = selected.some(t => t.pkg_id === pkg.pkg_id);

                if (!hasPkg && totalInPkg > 0 && inCart.length >= (totalInPkg / 2)) {
                    if (!dismissedAlerts.has(pkg.pkg_id)) showUpsellAlert(pkg);
                }
            });
        }

        function showUpsellAlert(pkg) {
            if(document.getElementById(`up-${pkg.pkg_id}`)) return;
            const toast = document.createElement('div');
            toast.id = `up-${pkg.pkg_id}`;
            toast.className = "fixed top-24 left-1/2 -translate-x-1/2 w-[90%] max-w-md bg-white border-l-8 border-amber-500 p-4 rounded-xl shadow-2xl z-[200] flex items-center gap-4 animate-upsell";
            toast.innerHTML = `
                <div class="bg-amber-100 p-3 rounded-full text-amber-600"><i class="fas fa-gem"></i></div>
                <div class="flex-1">
                    <p class="text-[10px] font-bold text-amber-600 uppercase">Save on ${pkg.n}</p>
                    <p class="text-xs text-slate-800 leading-tight">Switch to the full package for <b>â‚¹${pkg.p}</b>?</p>
                    <button onclick="applyPkg('${pkg.pkg_id}')" class="mt-2 bg-amber-500 text-white text-[10px] px-3 py-1 rounded-lg font-bold">UPGRADE NOW</button>
                </div>
                <button onclick="dismiss('${pkg.pkg_id}')" class="text-slate-300">âœ•</button>`;
            document.body.appendChild(toast);
        }

        function applyPkg(id) {
            const pkg = data.find(t => t.pkg_id === id);
            selected = selected.filter(t => t.p_id !== id);
            selected.push(pkg);
            dismiss(id);
            updateCart();
        }

        function dismiss(id) {
            const el = document.getElementById(`up-${id}`);
            if(el) el.remove();
            dismissedAlerts.add(id);
        }

        function generateMessage() {
            if(selected.length === 0) return;
            const list = selected.map(t => `â€¢ ${t.n}: â‚¹${testPrice(t)}`).join('\n');
            const sum = selected.reduce((a, b) => a + b.p, 0);
            const msg = `*CARE POINT DIAGNOSTICS*\n\n*Billing Summary:*\n${list}\n\n*TOTAL: â‚¹${sum}*\n\nðŸ“ Dombivli Branch`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function testPrice(t) { return t.p.toLocaleString('en-IN'); }

        async function copyToClipboard() {
            if(selected.length === 0) return;
            const list = selected.map(t => `â€¢ ${t.n}: â‚¹${testPrice(t)}`).join('\n');
            const sum = selected.reduce((a, b) => a + b.p, 0);
            const text = `CARE POINT DIAGNOSTICS\n\n${list}\n\nTOTAL: â‚¹${sum}`;
            await navigator.clipboard.writeText(text);
            const btn = document.getElementById('copyBtn');
            btn.innerHTML = "COPIED!";
            setTimeout(() => btn.innerHTML = '<i class="fas fa-copy"></i> COPY', 2000);
        }

        document.getElementById('mainSearch').oninput = (e) => {
            const activeBtn = document.querySelector('.filter-btn.bg-blue-600');
            render(activeBtn.dataset.filter, e.target.value);
        };

        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.onclick = () => {
                document.querySelectorAll('.filter-btn').forEach(b => {
                    b.classList.replace('bg-blue-600', 'bg-white');
                    b.classList.replace('text-white', 'text-slate-600');
                });
                btn.classList.replace('bg-white', 'bg-blue-600');
                btn.classList.replace('text-slate-600', 'text-white');
                render(btn.dataset.filter, document.getElementById('mainSearch').value);
            };
        });

        init();
    </script>
</body>
</html>
